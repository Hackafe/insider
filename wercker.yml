box: node

build:
  steps:
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"

    - npm-install
    - npm-test


deploy:
  steps:
    - add-to-known_hosts:
        hostname: $SERVER_HOSTNAME
        port: $SERVER_PORT
        fingerprint: d8:55:ba:80:9f:a2:09:57:60:40:8f:12:e3:75:10:17
    - add-ssh-key:
        keyname: DOKKU
        host: $SERVER_HOSTNAME
    - script:
        name: Add remote
        code: |
          git remote add wercker-dokku ssh://dokku@$SERVER_HOSTNAME:$SERVER_PORT/insider || true
    - script:
        name: Debug env
        code: |
          echo "# whoami"
          whoami || true
          echo "# ssh ..."
          ssh -p $SERVER_PORT -o StrictHostKeyChecking=no dokku@$SERVER_HOSTNAME apps || true
          echo "# cat /root/.ssh/config"
          cat /root/.ssh/config || true
          echo "# cat /etc/ssh/ssh_known_hosts"
          cat /etc/ssh/ssh_known_hosts || true
          echo "# git remote -v"
          git remote -v || true
          echo "# git fetch wercker-dokku"
          git fetch wercker-dokku || true
          echo "# git branch -a"
          git branch -a || true
    - script:
        name: Push to dokku
        code: |
          git push wercker-dokku $WERCKER_GIT_COMMIT:master -f
